{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
<h1 class="mb-4"><i class="fa fa-tachometer-alt text-primary"></i> Dashboard</h1>
<div class="row mb-4 g-4">
  <div class="col-lg-3 col-md-6">
    <div class="card shadow-sm border-0 text-center h-100 bg-gradient" style="background:linear-gradient(135deg,#23272b 60%,#0d6efd 100%)">
      <div class="card-body">
        <h6 class="card-title text-secondary">Počet klientů</h6>
        <div class="display-4 fw-bold text-warning">{{ pocet_klientu }}</div>
        <a href="{% url 'klient_list' %}" class="btn btn-sm btn-outline-light mt-2"><i class="fa fa-users"></i> Seznam klientů</a>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card shadow-sm border-0 text-center h-100 bg-gradient" style="background:linear-gradient(135deg,#23272b 60%,#20c997 100%)">
      <div class="card-body">
        <h6 class="card-title text-secondary">Objem hypoték</h6>
        <div class="display-4 fw-bold text-success">{{ objem_hypotek|floatformat:0 }} Kč</div>
        <a href="{% url 'klient_create' %}" class="btn btn-sm btn-outline-light mt-2"><i class="fa fa-plus"></i> Přidat klienta</a>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card shadow-sm border-0 text-center h-100 bg-gradient" style="background:linear-gradient(135deg,#23272b 60%,#ffc107 100%)">
      <div class="card-body">
        <h6 class="card-title text-secondary">Urgentní deadliny (do 3 dnů)</h6>
        <div class="display-4 fw-bold text-danger">{{ urgent_deadlines|length }}</div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="card shadow-sm border-0 text-center h-100 bg-gradient" style="background:linear-gradient(135deg,#23272b 60%,#6610f2 100%)">
      <div class="card-body">
        <h6 class="card-title text-secondary">Workflow rozložení</h6>
        <canvas id="workflowPieChart" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

{% if urgent_deadlines %}
  <div class="mb-4">
    <h4 class="text-danger"><i class="fa fa-exclamation-triangle"></i> Nejbližší deadliny</h4>
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle table-striped shadow" style="background:#23272b;color:#ffd700;">
        <thead class="table-light">
          <tr>
            <th>Jméno klienta</th>
            <th>Krok</th>
            <th>Termín</th>
            <th>Zbývá dní</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for item in urgent_deadlines %}
          <tr>
            <td><a href="{% url 'klient_detail' item.klient.pk %}" class="fw-bold" style="color:#fff;">{{ item.klient.jmeno }}</a></td>
            <td><span class="badge bg-dark" style="color:#fff;">{{ item.krok|cut:'deadline_'|title }}</span></td>
            <td>{{ item.deadline|date:"d.m.Y" }}</td>
            <td>{% if item.days_left < 0 %}<span class="badge badge-urgent">Po termínu</span>{% else %}{{ item.days_left }}{% endif %}</td>
            <td><a href="{% url 'klient_detail' item.klient.pk %}" class="btn btn-sm btn-outline-info"><i class="fa fa-eye"></i> Detail</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const workflowLabels = {{ workflow_labels|safe }};
const workflowCounts = {{ workflow_counts|safe }};
const ctxPie = document.getElementById('workflowPieChart').getContext('2d');
new Chart(ctxPie, {
  type: 'pie',
  data: {
    labels: workflowLabels.map(l => l.replace(/_/g, ' ').replace('hotovo', 'Hotovo').replace(/\b\w/g, c => c.toUpperCase())),
    datasets: [{
      data: workflowCounts,
      backgroundColor: [
        '#0d6efd','#6c757d','#198754','#ffc107','#dc3545','#20c997','#6610f2','#fd7e14','#6f42c1','#0dcaf0','#adb5bd','#f8d7da','#b6d4fe','#d1e7dd','#198754'
      ],
    }]
  },
  options: {
    plugins: {
      legend: {position: 'bottom', labels: {color: '#e0e0e0', font: {size: 13}}}
    }
  }
});
</script>
</div>
{% endblock %}
