{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4"><i class="fa fa-tachometer-alt text-primary"></i> Dashboard</h1>
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Počet klientů</h5>
        <div class="display-4 fw-bold">{{ pocet_klientu }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Objem hypoték</h5>
        <div class="display-4 fw-bold">{{ objem_hypotek|floatformat:0 }} Kč</div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card shadow-sm">
      <div class="card-body text-center">
        <h5 class="card-title">Urgentní deadliny (do 3 dnů)</h5>
        <div class="display-6 fw-bold text-danger">{{ urgent_deadlines|length }}</div>
      </div>
    </div>
  </div>
</div>

{% if urgent_deadlines %}
  <div class="mb-4">
    <h4 class="text-danger"><i class="fa fa-exclamation-triangle"></i> Nejbližší deadliny</h4>
    <div class="table-responsive">
      <table class="table table-sm table-warning table-bordered align-middle table-striped">
        <thead class="table-light">
          <tr>
            <th>Jméno klienta</th>
            <th>Krok</th>
            <th>Termín</th>
            <th>Zbývá dní</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for item in urgent_deadlines %}
          <tr>
            <td><a href="{% url 'klient_detail' item.klient.pk %}">{{ item.klient.jmeno }}</a></td>
            <td>{{ item.krok|cut:'deadline_'|title }}</td>
            <td>{{ item.deadline|date:"d.m.Y" }}</td>
            <td>{% if item.days_left < 0 %}<span class="badge badge-urgent">Po termínu</span>{% else %}{{ item.days_left }}{% endif %}</td>
            <td><a href="{% url 'klient_detail' item.klient.pk %}" class="btn btn-sm btn-outline-info"><i class="fa fa-eye"></i> Detail</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<div class="row mb-4">
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title"><i class="fa fa-chart-pie"></i> Rozložení klientů ve workflow</h5>
        <canvas id="workflowPieChart" height="180"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const workflowLabels = {{ workflow_labels|safe }};
const workflowCounts = {{ workflow_counts|safe }};
const ctxPie = document.getElementById('workflowPieChart').getContext('2d');
new Chart(ctxPie, {
  type: 'pie',
  data: {
    labels: workflowLabels.map(l => l.replace(/_/g, ' ').replace('hotovo', 'Hotovo').replace(/\b\w/g, c => c.toUpperCase())),
    datasets: [{
      data: workflowCounts,
      backgroundColor: [
        '#0d6efd','#6c757d','#198754','#ffc107','#dc3545','#20c997','#6610f2','#fd7e14','#6f42c1','#0dcaf0','#adb5bd','#f8d7da','#b6d4fe','#d1e7dd','#198754'
      ],
    }]
  },
  options: {plugins: {legend: {position: 'bottom'}}}
});
</script>
{% endblock %}
